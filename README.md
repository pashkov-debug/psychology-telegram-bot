# Telegram-–±–æ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∞ + –ø–æ–∏—Å–∫ –Ω–∞—É—á–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π (DOI / –Ω–∞–∑–≤–∞–Ω–∏–µ)

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç Telegram-–±–æ—Ç–∞ –Ω–∞ **aiogram 3.x**, –∫–æ—Ç–æ—Ä—ã–π:
- –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Å —Å—Å—ã–ª–∫–∞–º–∏ (—Å–∞–π—Ç / ‚Äú–æ–±–æ –º–Ω–µ‚Äù / –∫–æ–Ω—Ç–∞–∫—Ç—ã / –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ),
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞—è–≤–∫–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é (—Ç–µ–ª–µ—Ñ–æ–Ω + –∫—Ä–∞—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É,
- —É–º–µ–µ—Ç –∏—Å–∫–∞—Ç—å –Ω–∞—É—á–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –ø–æ **DOI** –∏–ª–∏ **–Ω–∞–∑–≤–∞–Ω–∏—é** (–≤ —Ç.—á. –º–µ–¥–∏—Ü–∏–Ω–∞/–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è) —á–µ—Ä–µ–∑ –Ω–∞–±–æ—Ä –≤–Ω–µ—à–Ω–∏—Ö API,
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Ö—Ä–∞–Ω–∏—Ç –∫–æ—Ä–æ—Ç–∫—É—é –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ –¥–µ–ø–ª–æ—è/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞, –µ—Å–ª–∏ –±–µ–∑ –¥–∏—Å–∫–∞).

> –í–∞–∂–Ω–æ: –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ HTML parse_mode, –ø–æ—ç—Ç–æ–º—É –ª—é–±—ã–µ —Ç–µ–∫—Å—Ç—ã –≤–∏–¥–∞ `<...>` –Ω—É–∂–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ `&lt;...&gt;`.

---

## 1) –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∫–æ–º–∞–Ω–¥—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –º–µ–Ω—é
- `/menu` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é
- `/find <–∑–∞–ø—Ä–æ—Å>` ‚Äî –ø–æ–∏—Å–∫ —Å—Ç–∞—Ç—å–∏ –ø–æ DOI –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é (–∞–≤—Ç–æ-–¥–µ—Ç–µ–∫—Ç)
- `/doi <10.xxxx/...>` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ DOI
- `/author <–ò–º—è –§–∞–º–∏–ª–∏—è>` ‚Äî –ø–æ–∏—Å–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∞–≤—Ç–æ—Ä–∞ (—á–µ—Ä–µ–∑ Crossref –∏–ª–∏ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä)
- `/history` ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
- `/clear_history` ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
- `/history_on` ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
- `/history_off` ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ –æ—á–∏—Å—Ç–∏—Ç—å

### –ú–µ–Ω—é (inline-–∫–Ω–æ–ø–∫–∏)
- üîé –ü–æ–∏—Å–∫ —Å—Ç–∞—Ç–µ–π
- üïò –ò—Å—Ç–æ—Ä–∏—è
- üìö –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω `SITE_FREE_URL`)
- üë§ –û–±–æ –º–Ω–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω `SITE_ABOUT_URL`)
- üóì –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
- ‚òéÔ∏è –ö–æ–Ω—Ç–∞–∫—Ç—ã (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω `SITE_CONTACT_URL`)
- üîí –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å

---

## 2) –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)

### –í—Ö–æ–¥–Ω—ã–µ —Ç–æ—á–∫–∏ (entrypoints)
–ï—Å—Ç—å –¥–≤–∞ —Ä–µ–∂–∏–º–∞ –∑–∞–ø—É—Å–∫–∞:

1) **Polling (Background Worker)** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è Render Worker  
   –§–∞–π–ª: `main.py`  
   - –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–µ–ª–∞–µ—Ç `getUpdates` –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–ø–¥–µ–π—Ç—ã.
   - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–º–∞–µ—Ç webhook –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.

2) **Webhook (Web Service)** ‚Äî –µ—Å–ª–∏ –Ω—É–∂–µ–Ω HTTP endpoint  
   –§–∞–π–ª: `app.py`  
   - –ø–æ–¥–Ω–∏–º–∞–µ—Ç `aiohttp.web` —Å–µ—Ä–≤–µ—Ä, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç webhook –æ—Ç Telegram.
   - —Ç—Ä–µ–±—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL –∏ —Å–µ–∫—Ä–µ—Ç.

> –ù–µ–ª—å–∑—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ webhook –∏ polling –Ω–∞ –æ–¥–Ω–æ–º —Ç–æ–∫–µ–Ω–µ.

### –õ–æ–≥–∏–∫–∞ –±–æ—Ç–∞
- `bot/handlers.py` ‚Äî –º–∞—Ä—à—Ä—É—Ç—ã –∫–æ–º–∞–Ω–¥, callback‚Äô–∏ –º–µ–Ω—é, —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø–∏—Å–∏, –ø–æ–∏—Å–∫ —Å—Ç–∞—Ç–µ–π.
- `bot/keyboards.py` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä.
- `bot/content.py` ‚Äî —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å—Å—ã–ª–∫–∏ (–∏–∑ ENV).
- `bot/states.py` ‚Äî FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è –∑–∞–ø–∏—Å–∏.
- `bot/db.py` ‚Äî SQLite + peewee (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏, –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤).
- `bot/runtime.py` ‚Äî runtime-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (aiohttp session, —Å–µ—Ä–≤–∏—Å—ã –ø–æ–∏—Å–∫–∞).
- `bot/services/*` ‚Äî –∫–ª–∏–µ–Ω—Ç—ã –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (Crossref, PubMed, Europe PMC, OpenAlex, Semantic Scholar, DOAJ, PLOS, bioRxiv/medRxiv, OSF preprints –∏ —Ç.–¥.), –ø–ª—é—Å –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä (LiteratureService).

---

## 3) –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
‚îú‚îÄ main.py # polling (worker)
‚îú‚îÄ app.py # webhook (web service)
‚îú‚îÄ requirements.txt
‚îî‚îÄ bot/
      ‚îú‚îÄ init.py
      ‚îú‚îÄ content.py
      ‚îú‚îÄ keyboards.py
      ‚îú‚îÄ states.py
      ‚îú‚îÄ handlers.py
      ‚îú‚îÄ db.py
      ‚îú‚îÄ runtime.py
      ‚îî‚îÄ services/
                ‚îú‚îÄ init.py
                ‚îú‚îÄ crossref.py
                ‚îú‚îÄ pubmed.py
                ‚îú‚îÄ europe_pmc.py
                ‚îú‚îÄ openalex.py
                ‚îú‚îÄ semanticscholar.py
                ‚îú‚îÄ doaj.py
                ‚îú‚îÄ plos.py
                ‚îú‚îÄ biorxiv.py
                ‚îú‚îÄ osf.py
                ‚îî‚îÄ literature.py


> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Ç–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ `bot/services/` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –Ω–∞–±–æ—Ä.

---

## 4) –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞

### `requirements.txt`
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- `aiogram` (3.x)
- `aiohttp` (3.x)
- `peewee` (3.x)

### `main.py` ‚Äî –∑–∞–ø—É—Å–∫ polling (Render Worker)
–ó–∞–¥–∞—á–∏:
- —á–∏—Ç–∞–µ—Ç `BOT_TOKEN`, `DB_PATH`, `USER_AGENT`, `CROSSREF_MAILTO` –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∫–ª—é—á–∏ API,
- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ë–î –∏ runtime (–≤–Ω–µ—à–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—ã),
- —Å–æ–∑–¥–∞–µ—Ç `Bot` –∏ `Dispatcher`,
- **—Å–Ω–∏–º–∞–µ—Ç webhook** (`delete_webhook`) –ø–µ—Ä–µ–¥ polling,
- —Å—Ç–∞—Ä—Ç—É–µ—Ç `start_polling`,
- –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –≤ `finally`.

> –í–∞–∂–Ω–æ: –¥–ª—è aiogram 3.7+ –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `parse_mode=` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä Bot; –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `DefaultBotProperties(...)` (—Å–º. —Ä–∞–∑–¥–µ–ª ‚Äú–û—à–∏–±–∫–∏ –¥–µ–ø–ª–æ—è‚Äù).

### `app.py` ‚Äî webhook Web Service (Render Web Service)
–ó–∞–¥–∞—á–∏:
- –ø–æ–¥–Ω–∏–º–∞–µ—Ç `aiohttp.web` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ,
- —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç webhook endpoint –≤–∏–¥–∞ `/webhook/<secret>`,
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –Ω–∞ startup —Å—Ç–∞–≤–∏—Ç webhook, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω `PUBLIC_BASE_URL`,
- –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `/health` endpoint,
- –∑–∞–∫—Ä—ã–≤–∞–µ—Ç runtime, –ë–î –∏ `bot.session` –Ω–∞ shutdown.

> –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ Render Worker (polling) ‚Äî `app.py` –≤–∞–º –Ω–µ –Ω—É–∂–µ–Ω.

### `bot/content.py` ‚Äî —Ç–µ–∫—Å—Ç—ã –∏ —Å—Å—ã–ª–∫–∏
–ó–∞–¥–∞—á–∏:
- —á–∏—Ç–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –∏–∑ ENV:
  - `SITE_HOME_URL`/`SITE_URL`, `SITE_FREE_URL`, `SITE_ABOUT_URL`, `SITE_CONTACT_URL`
- —Ö—Ä–∞–Ω–∏—Ç `WELCOME_TEXT`, `HELP_TEXT`, `SEARCH_INFO_TEXT`, `PRIVACY_TEXT`, `DISCLAIMER`
- **–≤–∞–∂–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç `<...>` –∫–∞–∫ `&lt;...&gt;`**, –∏–Ω–∞—á–µ Telegram HTML-–ø–∞—Ä—Å–µ—Ä –ø–∞–¥–∞–µ—Ç.

### `bot/keyboards.py` ‚Äî –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- `main_menu()` ‚Äî inline –º–µ–Ω—é; –ø—É–Ω–∫—Ç—ã ‚Äú–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ/–û–±–æ –º–Ω–µ/–ö–æ–Ω—Ç–∞–∫—Ç—ã‚Äù –ø–æ—è–≤–ª—è—é—Ç—Å—è, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏ –∑–∞–¥–∞–Ω—ã –≤ `SITE`.
- `link_button(text, url)` ‚Äî –∫–Ω–æ–ø–∫–∞-—Å—Å—ã–ª–∫–∞ + ‚Äú‚¨ÖÔ∏è –ú–µ–Ω—é‚Äù.
- `back_to_menu()` ‚Äî —Ç–æ–ª—å–∫–æ ‚Äú‚¨ÖÔ∏è –ú–µ–Ω—é‚Äù.
- `phone_request_kb()` ‚Äî reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å `request_contact=True`.
- `cancel_kb()` ‚Äî reply ‚Äú–û—Ç–º–µ–Ω–∞‚Äù.
- `confirm_kb()` ‚Äî inline: ‚Äú–û—Ç–ø—Ä–∞–≤–∏—Ç—å / –ò–∑–º–µ–Ω–∏—Ç—å / –û—Ç–º–µ–Ω–∞‚Äù.

### `bot/states.py` ‚Äî FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
–°–æ–¥–µ—Ä–∂–∏—Ç `BookingStates` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `phone`, `request_text`, `confirm`) –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –∑–∞–ø–∏—Å–∏.

### `bot/handlers.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
–°–æ–¥–µ—Ä–∂–∏—Ç:
- –∫–æ–º–∞–Ω–¥—ã `/start`, `/menu`, `/help`, `/find`, `/doi`, `/author`, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π;
- callback‚Äô–∏ –º–µ–Ω—é (privacy/search/history/free/about/contact/book);
- —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø–∏—Å–∏: –∑–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí –∑–∞–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–∞ ‚Üí –ø—Ä–µ–≤—å—é ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω—É;
- —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `html_escape`.

–ò—Å—Ç–æ—Ä–∏—è:
- –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ë–î: `command`, `query`, `result_title`, `result_url`.
- –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–µ —Å—Ç—Ä–æ–∫–∏.

–í–ê–ñ–ù–û –ø–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏:
- —Ç–µ–∫—Å—Ç –∑–∞—è–≤–∫–∏ (`request_text`) **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î**, —Ç–æ–ª—å–∫–æ –∂–∏–≤–µ—Ç –≤ FSM –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏.

### `bot/db.py` ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (peewee + SQLite)
–ú–æ–¥–µ–ª–∏:
- `User`: tg_user_id, username, full_name, history_enabled, timestamps
- `SearchHistory`: —Å–≤—è–∑—å —Å User, command/query/result_title/result_url, created_at

–§—É–Ω–∫—Ü–∏–∏:
- `init_db(db_path)`, `close_db()`
- `set_history_enabled()`, `is_history_enabled()`
- `add_history()`, `get_history_rows()`, `clear_history()`

> –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é SQLite —Ñ–∞–π–ª —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `data.db`. –ù–∞ Render –±–µ–∑ –¥–∏—Å–∫–∞ —ç—Ç–æ **—ç–øhemeral**: –∏—Å—Ç–æ—Ä–∏—è —Å–±—Ä–æ—Å–∏—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ ‚Äî —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é.

### `bot/runtime.py` ‚Äî runtime-—Å–∏–Ω–≥–ª—Ç–æ–Ω—ã
–û–±—ã—á–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- —Å–æ–∑–¥–∞–Ω–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –æ–±—â–µ–≥–æ `aiohttp.ClientSession`,
- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤–Ω–µ—à–Ω–∏—Ö API,
- —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∏–ø–∞ `get_crossref()`, `get_literature()` –∏ `close_runtime()`.

### `bot/services/*` ‚Äî –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å—Ç–∞—Ç–µ–π
–û–±—ã—á–Ω–æ –≤–∫–ª—é—á–∞–µ—Ç:
- `crossref.py` ‚Äî Crossref REST (DOI, –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–∞–≤—Ç–æ—Ä—É)
- `pubmed.py` ‚Äî NCBI Entrez (PMID, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –∏–Ω–æ–≥–¥–∞ DOI)
- `europe_pmc.py` ‚Äî Europe PMC REST
- `openalex.py` ‚Äî OpenAlex
- `semanticscholar.py` ‚Äî Semantic Scholar
- `doaj.py` ‚Äî DOAJ
- `plos.py` ‚Äî PLOS Search
- `biorxiv.py` ‚Äî bioRxiv / medRxiv
- `osf.py` ‚Äî OSF preprints (–Ω–∞–ø—Ä–∏–º–µ—Ä PsyArXiv)
- `literature.py` ‚Äî –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä (–µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∏—Å–∫–∞/lookup —Å fallback –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º)

---

## 5) –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (ENV)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
- `BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ (polite pool / –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
- `USER_AGENT` ‚Äî —Å—Ç—Ä–æ–∫–∞ user-agent (–ø—Ä–∏–º–µ—Ä: `psych-bot/1.0`)
- `CROSSREF_MAILTO` ‚Äî email –¥–ª—è Crossref polite pool (–ø—Ä–∏–º–µ—Ä: `you@example.com`)

### –°—Å—ã–ª–∫–∏ –¥–ª—è –º–µ–Ω—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `SITE_HOME_URL` –∏–ª–∏ `SITE_URL`
- `SITE_FREE_URL`
- `SITE_ABOUT_URL`
- `SITE_CONTACT_URL`

### –°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø–∏—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `ADMIN_CHAT_ID` ‚Äî –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞—è–≤–∫–∏ (–ª–∏—á–Ω—ã–π chat_id –∏–ª–∏ id –≥—Ä—É–ø–ø—ã)

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å—Ç–∞—Ç–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `NCBI_API_KEY`, `NCBI_EMAIL`, `NCBI_TOOL` (PubMed / NCBI)
- `PLOS_API_KEY`
- `SEMANTIC_SCHOLAR_API_KEY`
- `DOAJ_API_KEY`
- `OSF_PROVIDER` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `psyarxiv`)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- `DB_PATH` ‚Äî –ø—É—Ç—å –∫ sqlite —Ñ–∞–π–ª—É (–ø—Ä–∏–º–µ—Ä: `/tmp/data.db`)

### –¢–æ–ª—å–∫–æ –¥–ª—è webhook-—Ä–µ–∂–∏–º–∞ (`app.py`)
- `PUBLIC_BASE_URL` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π URL —Å–µ—Ä–≤–∏—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Render URL)
- `WEBHOOK_SECRET` ‚Äî –¥–ª–∏–Ω–Ω–∞—è —Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
- `PORT` ‚Äî –ø–æ—Ä—Ç (Render –æ–±—ã—á–Ω–æ —Å–∞–º –∑–∞–¥–∞–µ—Ç)

---

## 6) –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

### –í–∞—Ä–∏–∞–Ω—Ç A: Polling (–ø—Ä–æ—â–µ –≤—Å–µ–≥–æ)
1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt

---

### –¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ Render (–∏ –∫–∞–∫ —á–∏–Ω–∏—Ç—å)

–ù–∏–∂–µ ‚Äî –∏–º–µ–Ω–Ω–æ —Ç–µ –æ—à–∏–±–∫–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —è —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è.

## –û—à–∏–±–∫–∞ A: ModuleNotFoundError: No module named 'bot.content'

–ü—Ä–∏—á–∏–Ω–∞: —Ñ–∞–π–ª–∞ bot/content.py –Ω–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –∏–ª–∏ –ø–∞–∫–µ—Ç bot/ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–∞–∫–µ—Ç–æ–º Python (–Ω–µ—Ç bot/__init__.py), –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ –ø—É—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞.

–†–µ—à–µ–Ω–∏–µ:

—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å bot/__init__.py –∏ bot/content.py,

—á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ Render —Ç–∞–∫–∞—è –∂–µ, –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ,

—á—Ç–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

## –û—à–∏–±–∫–∞ B: TypeError: Passing parse_mode ... to Bot initializer is not supported anymore

–ü—Ä–∏—á–∏–Ω–∞: –Ω–∞—á–∏–Ω–∞—è —Å aiogram 3.7+ —É–±—Ä–∞–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã parse_mode=... –∏–∑ Bot(...).
–í—ã —ç—Ç–æ –≤–∏–¥–µ–ª–∏ –≤ –ª–æ–≥–∞—Ö Render.

–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):

–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

Bot(token=token, default=DefaultBotProperties(parse_mode=ParseMode.HTML))


–ª–∏–±–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é aiogram < 3.7 (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, —Ç.–∫. –≤—ã —É–∂–µ —Å—Ç–∞–≤–∏—Ç–µ aiogram>=3.0,<4.0).

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–∞ entrypoint‚Äô–∞:

main.py (polling)

app.py (webhook)

## –û—à–∏–±–∫–∞ C: Bad Request: can't parse entities: Unsupported start tag "–∑–∞–ø—Ä–æ—Å"

–ü—Ä–∏—á–∏–Ω–∞: –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ HTML parse_mode –∏ –Ω–∞–ø–∏—Å–∞–ª–∏ —Ç–µ–∫—Å—Ç –≤–∏–¥–∞:

... /find <–∑–∞–ø—Ä–æ—Å> ...
Telegram –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç <–∑–∞–ø—Ä–æ—Å> –∫–∞–∫ HTML-—Ç–µ–≥.

–†–µ—à–µ–Ω–∏–µ:

—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —É–≥–ª–æ–≤—ã–µ —Å–∫–æ–±–∫–∏: &lt;–∑–∞–ø—Ä–æ—Å&gt;

–∏–ª–∏ –∑–∞–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤ <code>...</code> –∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ‚Äú—Å—ã—Ä—ã–µ‚Äù < >.

## –û—à–∏–±–∫–∞ D: AttributeError: 'str' object has no attribute 'astimezone'

–ü—Ä–∏—á–∏–Ω–∞: created_at –∏–∑ SQLite –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –¥–æ—Å—Ç–∞–µ—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ get_history_rows()), –∞ –∫–æ–¥ –æ–∂–∏–¥–∞–µ—Ç datetime.

–†–µ—à–µ–Ω–∏–µ:

–ø—Ä–∏–≤–æ–¥–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫ datetime –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–≤–≤–µ—Å—Ç–∏ helper, –Ω–∞–ø—Ä–∏–º–µ—Ä _to_utc_dt()),

–ª–∏–±–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ Peewee –≤–µ—Ä–Ω–µ—Ç datetime (–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –ø—Ä–æ—â–µ —Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ handlers).

## –û—à–∏–±–∫–∞ E: TelegramConflictError: terminated by other getUpdates request

–ß—Ç–æ —ç—Ç–æ: —ç—Ç–æ –Ω–µ ‚Äú—Å–æ–Ω Render‚Äù, –∞ backoff –≤–Ω—É—Ç—Ä–∏ aiogram: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∂–¥—ë—Ç –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.

–ü—Ä–∏—á–∏–Ω—ã (—Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ):

—Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã 2 –ø—Ä–æ—Ü–µ—Å—Å–∞ polling —Å –æ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º

–≤—Ç–æ—Ä–æ–π Render Service (Web Service + Worker) –Ω–∞ –æ–¥–Ω–æ–º —Ç–æ–∫–µ–Ω–µ,

–ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –Ω–∞ –≤–∞—à–µ–º –ü–ö,

–≤—Ç–æ—Ä–æ–π –∏–Ω—Å—Ç–∞–Ω—Å –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞/–¥–µ–ø–ª–æ—è (—Ä–µ–¥–∫–æ, –Ω–æ –±—ã–≤–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ).

(—Ä–µ–∂–µ) –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ polling –∏–∑-–∑–∞ crash-loop.

–ß—Ç–æ –¥–µ–ª–∞—Ç—å:

—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Render —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç polling,

–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã,

–æ—Å—Ç–∞–≤—å—Ç–µ delete_webhook(...) –≤ main.py,

–µ—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç –∏ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –≤—Ç–æ—Ä–æ–π –ø—Ä–æ—Ü–µ—Å—Å ‚Äî –∫—Ä–∞–π–Ω—è—è –º–µ—Ä–∞: –ø–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω —É BotFather –∏ –æ–±–Ω–æ–≤–∏—Ç—å BOT_TOKEN –≤ Render (—ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ ‚Äú—É–±—å–µ—Ç‚Äù —Å—Ç–∞—Ä—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã).

## –û—à–∏–±–∫–∞ F: Unclosed client session

–ü—Ä–∏—á–∏–Ω–∞: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–ª–æ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è aiohttp —Å–µ—Å—Å–∏–∏ (–±–æ—Ç/–∫–ª–∏–µ–Ω—Ç—ã).
–ß–∞—â–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Å–æ–ø—É—Ç—Å—Ç–≤—É–µ—Ç –û—à–∏–±–∫–µ B (crash –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ).

–†–µ—à–µ–Ω–∏–µ:

–∑–∞–∫—Ä—ã–≤–∞—Ç—å bot.session.close() –∏ runtime –≤ finally (–∫–∞–∫ –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º main.py).

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º (smoke checklist)

 –í main.py –Ω–µ—Ç Bot(..., parse_mode=...), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DefaultBotProperties

 –í —Ç–µ–∫—Å—Ç–∞—Ö –Ω–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö <...> (—Ç–æ–ª—å–∫–æ &lt;...&gt; –∏–ª–∏ –±–µ–∑ —Å–∫–æ–±–æ–∫)

 –í main.py –µ—Å—Ç—å delete_webhook(drop_pending_updates=True)

 –ù–∞ Render —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç polling

 BOT_TOKEN –∑–∞–¥–∞–Ω –≤ Render Environment (–Ω–µ –≤ –∫–æ–¥–µ)

 –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∏—Å—Ç–æ—Ä–∏—é ‚Äî DB_PATH —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ writeable path (/tmp/data.db)


### –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ Render –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –¥–∏—Å–∫–∞.

### –í–Ω–µ—à–Ω–∏–µ API –º–æ–≥—É—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–±–ª—é–¥–∞—Ç—å ‚Äúpolite usage‚Äù (USER_AGENT, mailto, –ø–∞—É–∑—ã/–ª–∏–º–∏—Ç—ã).
